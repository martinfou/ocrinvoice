name: Release Folder Package

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write
  packages: write

jobs:
  build:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [windows-latest, macos-latest]
        python-version: ['3.11']

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}

    - name: Install Tesseract OCR and Poppler (macOS)
      if: matrix.os == 'macos-latest'
      run: |
        brew install tesseract poppler

    - name: Install Tesseract OCR and Poppler (Windows)
      if: matrix.os == 'windows-latest'
      run: |
        choco install tesseract poppler
        echo "$env:ProgramFiles\Tesseract-OCR" >> $env:GITHUB_PATH
        echo "$env:ProgramFiles\poppler\bin" >> $env:GITHUB_PATH

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -e ".[dev]"
        pip install pyinstaller

    - name: Build folder package
      run: |
        pyinstaller OCRInvoiceParser-folder.spec

    - name: Copy Tesseract and Poppler binaries (Windows)
      if: matrix.os == 'windows-latest'
      shell: bash
      run: |
        # Copy Tesseract binaries if they exist
        if [ -d "C:\Program Files\Tesseract-OCR" ]; then
          echo "Copying Tesseract from C:\Program Files\Tesseract-OCR"
          cp -r "C:\Program Files\Tesseract-OCR\*" dist/OCRInvoiceParser/
        else
          echo "Warning: Tesseract directory not found at C:\Program Files\Tesseract-OCR"
        fi
        
        # Copy Poppler binaries if they exist
        if [ -d "C:\Program Files\poppler\bin" ]; then
          echo "Copying Poppler from C:\Program Files\poppler\bin"
          cp -r "C:\Program Files\poppler\bin\*" dist/OCRInvoiceParser/
        else
          echo "Warning: Poppler directory not found at C:\Program Files\poppler\bin"
        fi

    - name: Copy Tesseract and Poppler binaries (macOS)
      if: matrix.os == 'macos-latest'
      run: |
        # Find Tesseract installation path
        TESSERACT_PATH=$(which tesseract)
        if [ -z "$TESSERACT_PATH" ]; then
          echo "Tesseract not found in PATH"
          exit 1
        fi
        echo "Found Tesseract at: $TESSERACT_PATH"
        
        # Copy Tesseract binary
        cp "$TESSERACT_PATH" dist/OCRInvoiceParser/
        
        # Find and copy tessdata
        TESSDATA_PATH=$(tesseract --tessdata-dir 2>/dev/null || echo "/usr/local/share/tessdata")
        if [ -d "$TESSDATA_PATH" ]; then
          cp -r "$TESSDATA_PATH" dist/OCRInvoiceParser/
        else
          echo "Warning: tessdata directory not found at $TESSDATA_PATH"
        fi
        
        # Find and copy Poppler binaries
        for pdf_tool in pdfinfo pdftoppm pdftotext pdftocairo; do
          PDF_TOOL_PATH=$(which $pdf_tool 2>/dev/null || echo "")
          if [ -n "$PDF_TOOL_PATH" ]; then
            echo "Found $pdf_tool at: $PDF_TOOL_PATH"
            cp "$PDF_TOOL_PATH" dist/OCRInvoiceParser/
          else
            echo "Warning: $pdf_tool not found"
          fi
        done
        
        # Copy required libraries if they exist
        for lib in /usr/local/lib/libpoppler* /opt/homebrew/lib/libpoppler*; do
          if [ -f "$lib" ]; then
            echo "Copying library: $lib"
            cp "$lib" dist/OCRInvoiceParser/
          fi
        done

    - name: Create startup script (Windows)
      if: matrix.os == 'windows-latest'
      run: |
        echo '@echo off' > dist/OCRInvoiceParser/run.bat
        echo 'set PATH=%~dp0;%PATH%' >> dist/OCRInvoiceParser/run.bat
        echo 'OCRInvoiceParser.exe %*' >> dist/OCRInvoiceParser/run.bat

    - name: Create startup script (macOS)
      if: matrix.os == 'macos-latest'
      run: |
        echo '#!/bin/bash' > dist/OCRInvoiceParser/run.sh
        echo 'export PATH="$(dirname "$0"):$PATH"' >> dist/OCRInvoiceParser/run.sh
        echo '$(dirname "$0")/OCRInvoiceParser "$@"' >> dist/OCRInvoiceParser/run.sh
        chmod +x dist/OCRInvoiceParser/run.sh

    - name: Create README for package
      run: |
        cat > dist/OCRInvoiceParser/README.txt << 'EOF'
        OCR Invoice Parser - Standalone Package
        
        This package contains everything needed to run the OCR Invoice Parser
        without requiring separate installation of Tesseract OCR or Poppler.
        
        To run the application:
        
        Windows:
        - Double-click run.bat
        - Or run OCRInvoiceParser.exe directly
        
        macOS:
        - Double-click run.sh
        - Or run ./OCRInvoiceParser directly
        
        Requirements:
        - Windows 10+ or macOS 10.14+
        - 4GB RAM recommended
        
        Note: This package includes Tesseract OCR and Poppler binaries.
        No additional software installation is required.
        EOF

    - name: Create ZIP archive
      run: |
        cd dist
        if [ "${{ matrix.os }}" = "windows-latest" ]; then
          7z a -tzip OCRInvoiceParser-Windows.zip OCRInvoiceParser/
        else
          zip -r OCRInvoiceParser-macOS.zip OCRInvoiceParser/
        fi

    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: OCRInvoiceParser-${{ matrix.os }}-folder
        path: dist/OCRInvoiceParser-*.zip

  create-release:
    runs-on: ubuntu-latest
    needs: build
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Download all artifacts
      uses: actions/download-artifact@v4

    - name: Prepare release files
      run: |
        # Find and rename the ZIP files
        find . -name "OCRInvoiceParser-*.zip" -exec mv {} . \;

    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        files: |
          OCRInvoiceParser-Windows.zip
          OCRInvoiceParser-macOS.zip
        body: |
          # OCR Invoice Parser v${{ github.ref_name }} - Folder Package

          ## 🎉 Standalone Package Release

          ### 📦 Downloads
          - **Windows**: OCRInvoiceParser-Windows.zip
          - **macOS**: OCRInvoiceParser-macOS.zip

          ### 🚀 Quick Start
          1. Download the ZIP file for your platform
          2. Extract the ZIP file to a folder
          3. Run the application:
             - **Windows**: Double-click `run.bat` or `OCRInvoiceParser.exe`
             - **macOS**: Double-click `run.sh` or run `./OCRInvoiceParser`

          ### ✨ What's Included
          - Complete OCR Invoice Parser application
          - **Tesseract OCR** - No separate installation needed
          - **Poppler** - PDF processing tools included
          - All Python dependencies bundled
          - Configuration files included

          ### 📋 System Requirements
          - Windows 10+ or macOS 10.14+
          - 4GB RAM recommended
          - No additional software installation required

          ### 🔧 Manual Installation
          If you prefer to install from source:
          ```bash
          git clone https://github.com/martinfou/ocrinvoice.git
          cd ocrinvoice
          pip install -e .
          python run_ocr_gui.py
          ```

          ### 📝 Package Contents
          - `OCRInvoiceParser.exe` / `OCRInvoiceParser` - Main executable
          - `run.bat` / `run.sh` - Convenient startup scripts
          - `tesseract.exe` / `tesseract` - OCR engine
          - `pdf*` tools - Poppler PDF utilities
          - `config/` - Configuration files
          - `README.txt` - This information
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }} 